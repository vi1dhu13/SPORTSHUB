<!DOCTYPE html>
<html>
<head>
    <title>Fitness Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js"></script>
    
    <style>
        body {
            display: flex;
        }

        #left-container {
            width: 70%;
            padding: 20px;
        }

        #left-box {
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        #center-box {
            border: 2px dashed #aaa;
            padding: 20px;
            margin: 20px;
            width: 30%;
            overflow: auto;
        }

        .workout-box {
            border: 1px solid #ddd;
            padding: 2px;
            margin: 2px;
            cursor: move;
            width: 100%;
        }

        #calendar {
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <h4>Fitness Calendar</h4>
        <div>
            <!-- Assuming you have a form for selecting a client -->
            <label for="client">Select Client:</label>
            <select id="client" name="client">
                {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="left-container">
            <form id="filter-form" class="form-inline mb-4">
                <div class="form-group mr-2">
                    <label for="workout-type" class="mr-2">Workout Type:</label>
                    <select id="workout-type" name="workout_type" class="form-control">
                        <option value="">All</option>
                        {% for key, value in workout_types.items %}
                            <option value="{{ key }}">{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
    
                
                <div class="form-group mr-2">
                    <label for="workout-name" class="mr-2">Workout Name:</label>
                    <input type="text" id="workout-name" name="workout_name" class="form-control">
                </div>
    
                <button type="submit" class="btn btn-primary">Apply Filters</button>
            </form>
    
            <div id="left-box" class="clearfix">
                <h2 class="mb-3">Exercises</h2>
                {% for workout in workouts %}
                    <div id="workout_{{ workout.id }}" class="workout-box" draggable="true" ondragstart="drag(event)">
                        <h3>{{ workout.name }}</h3>
                    </div>
                {% endfor %}
            </div>
        </div>
    
        <div id="center-box" class="drop-box clearfix" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h2 class="mb-3">Drop Exercises Here</h2>
        </div>
    
        <div id='calendar'></div>
        <button id="save-button">Save</button>
    </div>
</div>
<script>
            document.addEventListener('DOMContentLoaded', function () {
            var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                editable: true,
                droppable: true,
                events: [], // Leave it empty initially

                // Function to handle the dropping of exercises into the calendar
                drop: function (info) {
                    var workoutName = info.draggedEl.querySelector('h3').innerText;
                    var eventData = {
                        title: workoutName,
                        start: info.dateStr,
                        allDay: true
                    };

                    calendar.addEvent(eventData);
                }
            });

            calendar.render();

            // Add event listener for form submission
            document.getElementById('filter-form').addEventListener('submit', function (event) {
                event.preventDefault();
                applyFilters();
            });

            // Function to apply filters
            function applyFilters() {
                var form = document.getElementById('filter-form');
                var formData = new FormData(form);

                // Fetch filtered results
                fetch('/Training/filter_workouts/', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        // Update the left-box with filtered results
                        var leftBox = document.getElementById('left-box');
                        leftBox.innerHTML = '<h2>Exercises</h2>';

                        data.forEach(function (workout) {
                            var workoutBox = document.createElement('div');
                            workoutBox.id = 'workout_' + workout.id;
                            workoutBox.className = 'workout-box';
                            workoutBox.draggable = true;
                            workoutBox.ondragstart = drag;
                            workoutBox.innerHTML = '<h3>' + workout.name + '</h3>';
                            leftBox.appendChild(workoutBox);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            }

            function allowDrop(event) {
                event.preventDefault();
            }

            function drag(event) {
                event.dataTransfer.setData("text", event.target.id);
            }
        });
    $(document).ready(function () {
        var calendar = $('#calendar').fullCalendar({
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            selectable: true,
            selectHelper: true,
            editable: true,
            eventLimit: true,
            events: [],
            select: function (start, end, allDay) {
                // Get the logged-in trainer's ID from the session
                var trainerId = '{{ request.user.trainer.id }}';

                // Display the selected options and provide a save button in the modal/form
                // (Implement your own logic based on your UI design)

                // On save, send an AJAX request to save the daily event
                $('#save-button').click(function () {
                    // Get the selected workouts
                    var workouts = [];
                    $('#external-events .selected').each(function () {
                        workouts.push({
                            id: $(this).data('event').id,
                            title: $(this).data('event').title
                        });
                    });

                    // Make an AJAX request to save the daily event
                    $.ajax({
                        type: "POST",
                        url: '/save_daily_event/',
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'trainer': trainerId,
                            'client': $('#client').val(),  // Assuming you also want to include the client ID
                            'workouts': JSON.stringify(workouts),
                            'start': start.format(),
                            'end': end.format(),
                        },
                        dataType: "json",
                        success: function (data) {
                            calendar.fullCalendar('refetchEvents');
                            alert("Daily Event Added Successfully");
                        },
                        error: function (data) {
                            alert('There is a problem adding the daily event!!!');
                        }
                    });
                });

                // ...
            },
            eventReceive: function (event) {
                // Handle the event when it is dropped onto the calendar
                // ...
            },
            // Other callbacks...
        });

        // Make external events draggable
        $('#external-events .fc-event').each(function () {
            $(this).data('event', {
                title: $.trim($(this).text()),
                id: $(this).data('event-id'),  // Added the event ID
                stick: true
            });

            $(this).draggable({
                zIndex: 999,
                revert: true,
                revertDuration: 0,
                helper: 'clone',  // Use a clone while dragging
                start: function (e, ui) {
                    $(ui.helper).addClass('selected');
                },
                stop: function (e, ui) {
                    $('.selected').removeClass('selected');
                }
            });
        });
    });
</script>
</body>
</html>
