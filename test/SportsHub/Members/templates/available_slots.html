<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Make Reservation</title>
    <!-- Include Bootstrap CSS (if not already included) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1>Make Reservation</h1>

        <!-- Reservation Form -->
        <form method="post" id="reservation-form">
            {% csrf_token %}
            
            <!-- Date Selection -->
            <div class="form-group">
                <label for="reservation_date">Select Date:</label>
                <input type="date" id="reservation_date" name="reservation_date" class="form-control" required>
            </div>

            <!-- User Selection -->
            <div class="form-group">
                <label for="selected_user">Select Fitness User:</label>
                <select id="selected_user" name="selected_user" class="form-control" required>
                    <option value="">Select a fitness user</option>
                    <!-- Add options for fitness users here -->
                </select>
            </div>

            <!-- Available Slots Display -->
            <div id="available-slots" class="mt-4">
                <!-- Available slots will be displayed here using JavaScript/jQuery -->
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary mt-2">Reserve Slot</button>
        </form>
    </div>

    <!-- Include jQuery and Bootstrap JS (if not already included) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Initialize the date picker -->
    <script>
        $(document).ready(function () {
            $('#reservation_date').datepicker({
                dateFormat: 'yy-mm-dd',  // Set the desired date format
                minDate: 0,  // Allow selecting only future dates
            });
        });
    </script>

    <!-- AJAX for getting available slots -->
    <script>
        $(document).ready(function () {
            $('#reservation-form').on('submit', function (e) {
                e.preventDefault();
                var selectedDate = $('#reservation_date').val();
                var selectedUser = $('#selected_user').val();
                $.ajax({
                    url: '{% url 'get_available_slots' %}',
                    type: 'GET',
                    data: {
                        'date': selectedDate,
                        'user_id': selectedUser,
                    },
                    dataType: 'json',
                    success: function (data) {
                        var slotsHTML = '<h2>Available Slots</h2>';
                        if (data.available_slots.length > 0) {
                            slotsHTML += '<ul>';
                            data.available_slots.forEach(function (slot) {
                                slotsHTML += '<li>' + slot.start_time + ' - ' + slot.end_time +
                                    ' <button class="btn btn-success reserve-slot" data-slot-id="' + slot.slot_id + '">Reserve</button></li>';
                            });
                            slotsHTML += '</ul>';
                        } else {
                            slotsHTML += '<p>No available slots for the selected date and user.</p>';
                        }
                        $('#available-slots').html(slotsHTML);
                    },
                    error: function () {
                        alert('An error occurred while fetching available slots.');
                    }
                });
            });
        });
    </script>

    <!-- AJAX for making reservations -->
    <script>
        $(document).ready(function () {
            $('#available-slots').on('click', '.reserve-slot', function () {
                var slotId = $(this).data('slot-id');
                var selectedDate = $('#reservation_date').val();
                var selectedUser = $('#selected_user').val();
                $.ajax({
                    url: '{% url 'make_reservation' %}',
                    type: 'POST',
                    data: {
                        'selected_slot': slotId,
                        'selected_user': selectedUser,
                        'reservation_date': selectedDate,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (data.success) {
                            alert('Slot reserved successfully.');
                            // You can update the UI here as needed, e.g., remove the reserved slot from the list.
                        } else {
                            alert('Failed to reserve the slot. Please try again.');
                        }
                    },
                    error: function () {
                        alert('An error occurred while reserving the slot.');
                    }
                });
            });
        });
    </script>
</body>
</html>
